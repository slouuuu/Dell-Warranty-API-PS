<#
.SYNOPSIS
    Retrieves warranty information for Dell computers using Dell's API.

.DESCRIPTION
    This function retrieves warranty information for Dell computers using their API.
    It can store the API key securely, display warranty information, and optionally
    store warranty details in the Windows Registry.

.PARAMETER Api
    Switch to set up or update your Dell API key.

.PARAMETER Brand
    Switch to store warranty information in the Windows Registry (requires admin rights).

.PARAMETER ServiceTag
    Dell Service Tag to lookup. If not specified, uses the current computer's Service Tag.

.PARAMETER Show
    Switch to display warranty information in the console.

.PARAMETER KeyStorage
    Specifies how to store the API key: "Plain" (text file) or "Secure" (encrypted).

.EXAMPLE
    Get-DellWarranty -Api -KeyStorage Secure
    # Sets up your Dell API key with secure storage

.EXAMPLE
    Get-DellWarranty -Show
    # Shows warranty information for the current computer

.EXAMPLE
    Get-DellWarranty -ServiceTag "ABC123D" -Show
    # Shows warranty information for a specific Service Tag

.EXAMPLE
    Get-DellWarranty -Brand
    # Stores warranty information in the registry (requires admin rights)

.NOTES
    Author: Your Name
    Version: 1.0
    Last Updated: April 28, 2025
    
    You will need a Dell API key to use this script.
    Get one at: https://developer.dell.com/
#>
function Get-DellWarranty {
    [CmdletBinding()]
    Param(
        [Switch]$Api,
        [Switch]$Brand,
        [String]$ServiceTag = (Get-WmiObject -Class "Win32_Bios").SerialNumber,
        [Switch]$Show,
        [ValidateSet("Plain", "Secure")]
        [String]$KeyStorage = "Plain"
    )
    
    $apiKeyPath = "$env:appdata\Microsoft\Windows\PowerShell\DellAPI.txt"
    $secureKeyPath = "$env:appdata\Microsoft\Windows\PowerShell\DellAPI.xml"
    
    # Configure API key
    if ($Api) {
        if ($KeyStorage -eq "Plain") {
            Read-Host -Prompt "Please provide Dell API Key" | Out-File $apiKeyPath -Force
            Write-Host "`nAPI key saved as plain text at $apiKeyPath"
        }
        else {
            Read-Host -Prompt "Please provide Dell API Key" -AsSecureString | 
                ConvertFrom-SecureString | 
                Out-File $secureKeyPath -Force
            Write-Host "`nAPI key saved securely at $secureKeyPath"
        }
        
        Write-Host "You can now run this with optional -Brand parameter to save warranty info to registry"
        Write-Host "If you need to change the API Key, please run 'Get-DellWarranty -Api' again."
        return
    }
    
    # Retrieve API key based on storage method
    if (Test-Path $secureKeyPath) {
        $secureString = Get-Content $secureKeyPath | ConvertTo-SecureString
        $APIKey = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto(
            [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($secureString))
    }
    elseif (Test-Path $apiKeyPath) {
        $APIKey = Get-Content $apiKeyPath
    }
    else {
        Write-Host "`nPlease run 'Get-DellWarranty -Api' to provide Dell API Key"
        Write-Host "Use -KeyStorage Plain or -KeyStorage Secure to specify how to store the key"
        return
    }
    
    # If service tag is not the current machine, show results by default
    if ($ServiceTag -ne (Get-WmiObject -Class "Win32_Bios").SerialNumber) {
        $Show = $true
    }
    
    # Get Dell warranty information
    $URI = "https://api.dell.com/support/assetinfo/v4/getassetwarranty/${ServiceTag}?apikey=${APIKey}"
    
    try {
        $Request = Invoke-RestMethod -URI $URI -Method GET
        
        # Filter out unwanted warranty types
        $Warranties = $Request.AssetWarrantyResponse.assetentitlementdata | 
            Where-Object { $_.ServiceLevelDescription -notin @('Dell Digitial Delivery', 'Collect and Return Support') }
        
        $AssetDetails = $Request.AssetWarrantyResponse.assetheaderdata
        $Device = $Request.AssetWarrantyResponse.ProductHeaderData.SystemDescription
        
        # Extract dates
        $StartDate = ($Warranties | Select-Object -ExpandProperty StartDate).Split("T")[0]
        $EndDate = ($Warranties | Select-Object -ExpandProperty EndDate).Split("T")[0]
        $ShippedDate = ($AssetDetails.ShipDate).Split("T")[0]
        $Support = $Warranties | Select-Object -ExpandProperty ServiceLevelDescription
        
        # Display information if requested
        if ($Show) {
            Write-Host "`nDevice: $Device (Service Tag: $ServiceTag)"
            Write-Host "Original ship date: $ShippedDate"
            Write-Host "Warranty started: $StartDate"
            Write-Host "Warranty ends: $EndDate"
            Write-Host "Support level: $Support"
        }
        
        # Save to registry if requested
        if ($Brand) {
            # Check for admin rights
            if (-not ([Security.Principal.WindowsIdentity]::GetCurrent().Groups -match "S-1-5-32-544")) {
                Write-Host "`nYou need to use an elevated PowerShell window for -Brand to work"
                return
            }
            
            $registryPath = "HKLM:\SOFTWARE\WARRANTY"
            
            # Create registry path if it doesn't exist
            if (-not (Test-Path $registryPath)) {
                New-Item $registryPath -Force | Out-Null
            }
            
            # Save warranty info to registry
            $registryEntries = @{
                'WarrantyStartDate' = $StartDate
                'WarrantyEndDate' = $EndDate
                'WarrantySupportLevel' = $Support
                'Model' = $Device
                'OriginalShipDate' = $ShippedDate
                'ServiceTag' = $ServiceTag
            }
            
            foreach ($entry in $registryEntries.GetEnumerator()) {
                New-ItemProperty -Path $registryPath -Name $entry.Key -Value $entry.Value -PropertyType ExpandString -Force | Out-Null
            }
            
            Write-Host "`nWarranty information saved to registry at $registryPath"
        }
        
        # Return warranty information as an object
        return [PSCustomObject]@{
            ServiceTag = $ServiceTag
            Model = $Device
            WarrantyStartDate = $StartDate
            WarrantyEndDate = $EndDate
            SupportLevel = $Support
            ShipDate = $ShippedDate
        }
    }
    catch {
        Write-Host "`nError retrieving warranty information: $_"
    }
}
